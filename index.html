<html>
    <head>
        <title>UMS: Dashboard Dev</title>
        <!-- dygraph is nicely interactive and just works without many options to set -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js"></script>

        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
        <script type="infowindow/html" id="infowindow_template"></script>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>

        <!--script src="./lib/jquery.csv-0.71.min.js"></script> <!-- to read csv file -->

        <!--script src="../secret.js"></script> <!-- in case want to access admin tables on CartoDB eg list all columns in table -->

        <style>
            html, body {width:100%; height:100%; padding: 0; margin: 0;}
            #map { position: absolute; right:0px; top:0px; width: 70%; height:100%; background: black; }

            #dashboard { position: absolute; left:0px; top:0px; width: 30%; height:100%; background: white; }

            #temperature-chart { position: absolute; left: 10px; top: 50px; width: 80%; height: 200px; z-index: 5; }

            #humidity-chart { position: absolute; left: 10px; top: 300px; width: 500px; height: 200px; z-index: 5; }

            #accelerometer-chart { position: absolute; left: 10px; top: 550px; width: 80%; height: 200px; z-index: 5; }

            #menu { position: absolute; top: 5px; right: 10px; width: 400px; height:60px; background: transparent; z-index:10;}
            #menu a {
                margin: 15px 10px 0 0;
                float: right;
                vertical-align: baseline;
                width: 70px;
                padding: 10px;
                text-align: center;
                font: bold 11px "Helvetica",Arial;
                line-height: normal;
                color: #555;
                border-radius: 4px;
                border: 1px solid #777777;
                background: #ffffff;
                text-decoration: none;
                cursor: pointer;
            }
            #menu a.selected,
            #menu a:hover {
                color: #F84F40;
            }
        </style>

        <script>
            // global variables
            var map;
            var cdb_sql = new cartodb.SQL({ user: 'crshunter' }),
            //var cdb_sql = new cartodb.SQL({ user: secret.USER, api_key: secret.API_KEY }),
                // summary_tbl = 'ums_roadtest0917_minuteaverages',
                summary_tbl = 'pilotb_sample1_averages',
                //raw_tbl = 'ums_roadtest_0917',
                raw_tbl = 'pilotb_sample1',
                // viz_url = 'https://crshunter.cartodb.com/api/v2/viz/4e2642ce-7d07-11e5-abc8-0ecfd53eb7d3/viz.json',
                viz_url = 'https://crshunter.cartodb.com/api/v2/viz/fb0606b2-80d8-11e5-8d62-0e3ff518bd15/viz.json'
                viz_var = 'amb_temp';

            var sql_summ = 'SELECT * FROM ' + summary_tbl,
                sql_raw = 'SELECT * FROM ' + raw_tbl;

            var LayerActions;

            var sublayers = [],
                binsRaw = [],
                binsSumm = [],
                summCSS,
                rawCSS,
                dataRoads= {headers: [], data: []},
                dataQuarters = {headers: [], data: []}; // new format fory dygraph
            //= { labels: [], temps: [], humid: [] }; // old format for chart.js

            function readTextFile(file)
            {
                var rawFile = new XMLHttpRequest();
                rawFile.open("GET", file, false);
                rawFile.onreadystatechange = function ()
                {
                    if(rawFile.readyState === 4)
                    {
                        if(rawFile.status === 200 || rawFile.status == 0)
                        {
                            var allText = rawFile.responseText;
                            alert(allText);
                        }
                    }
                }
                rawFile.send(null);
            }

            // initialize data parameters
            function init(){
                console.log('starting init');

                // set bins with default values
                var qrySumm = "SELECT CDB_JenksBins(array_agg(round(" + viz_var + "::numeric, 2)), 7) FROM " + summary_tbl;
                var qryRaw = "SELECT CDB_JenksBins(array_agg(round(" + viz_var + "::numeric, 2)), 7) FROM " + raw_tbl;

                // get table columns
                /* works fine but needs API key, shouldn't have on public github site...
                var qryCols = "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = '" + raw_tbl +"'";
                console.log('qryCols is', qryCols);
                var columns = { colName: [], dataType: [] };
                cdb_sql.execute(qryCols).done(function(cols){
                    for (i in cols.rows){
                        columns.colName.push(cols.rows[i].column_name);
                        columns.dataType.push(cols.rows[i].data_type);
                    }
                    // console.log('columns is', columns);
                });
                */
                cdb_sql.execute(qrySumm).done(function(jenks){
                    binsSumm = jenks.rows[0].cdb_jenksbins
                    //console.log('jenks returned: ', jenks.rows[0].cdb_jenksbins[0], ' 2nd record is ', jenks.rows[0].cdb_jenksbins[1]);
                    summCSS = makeCartoCSS(summary_tbl, binsSumm, viz_var);
                    //console.log('summCSS created as:', summCSS);
                });

                cdb_sql.execute(qryRaw).done(function(jenks){
                    binsRaw = jenks.rows[0].cdb_jenksbins
                    //console.log('jenks returned: ', jenks.rows[0].cdb_jenksbins[0], ' 2nd record is ', jenks.rows[0].cdb_jenksbins[1]);
                    rawCSS = makeCartoCSS(raw_tbl, binsRaw, viz_var);
                });

                // update to call from raw data table, but take too long?
                //var //qryTemp = "SELECT round(avg(amb_temp)::numeric, 2) avg_temp, round(avg(amb_humid)::numeric, 2) avg_humid, ",
                    //qryTemp = qryTemp + "extract(hour from time_intmin)*100 + ceil(extract(minute from time_intmin)/60*100) as hour_quarter ",
                    //qryTemp = qryTemp + "time_intmin ",
                    //qryTemp = qryTemp + "FROM ums_roadtest0917_minuteaverages GROUP BY time_intmin ORDER BY time_intmin ASC";

                var qryTemp = "SELECT round((extract('hour' from gps_datetimestamp)*100 + extract('minute' from gps_datetimestamp)/60*100)::numeric, 2) as time_var, ", // + ",
                    //qryTemp = qryTemp + "extract('second' from gps_datetimestamp)/60)::numeric, 2) as time_var, ",
                    qryTemp = qryTemp + 'round(avg(' + viz_var + ")::numeric, 2) amb_temp, round(avg(amb_humd)::numeric, 2) amb_humd ",
                    qryTemp = qryTemp + "FROM " + raw_tbl + " GROUP BY time_var ORDER BY time_var;"

                // console.log('qryTemp is:', qryTemp);

                cdb_sql.execute(qryTemp)
                .done(function(data) {
                    // look at data, how access returned column names?
                    // console.log('temperature keys are:', Object.keys(data.fields));
                    dataQuarters.headers = ['time', 'temperature', 'humidity'];
                    for (i in data.rows){
                        dataQuarters.data.push([data.rows[i].time_var, data.rows[i].amb_temp, data.rows[i].amb_humd]);
                    }
                    // console.log(JSON.stringify(dataQuarters));
                    // main(); // only call main once data is returned
                });

                // test 50k records of raod quality means...
                var qryRoad = "SELECT gps_datetimestamp, rdq_acxmea, rdq_acymea, rdq_aczmea FROM pilotb_sample1"
                cdb_sql.execute(qryRoad)
                .done(function(data){

                    dataRoads.headers = Object.keys(data.fields); //['time', 'avg_temp', 'avg_humid'];
                    console.log('dataRoads headers are:', dataRoads.headers.toString());
                    for (i in data.rows){
                        dataRoads.data.push([new Date(data.rows[i].gps_datetimestamp), data.rows[i].rdq_acxmea, data.rows[i].rdq_acymea, data.rows[i].rdq_aczmea]);
                    }
                    console.log('length of road data is', dataRoads.data.length);
                    main(); // only call main once data is returned
                });

                // set up layer switching
                LayerActions = {
                    summary: function(){
                        sublayers[0].show()
                        sublayers[1].hide()
                        //console.log('summary layer interactivity', sublayers[0].get('interactivity'));
                        //console.log('summary layer cartocss', sublayers[0].get('cartoss'));
                        return true;
                    },
                    raw: function(){
                        sublayers[1].show()
                        sublayers[0].hide()
                        //console.log('raw layer interactivity', sublayers[1].get('interactivity'));
                        //console.log('raw layer css', sublayers[1].get('cartocss'));
                        return true;
                    }
                }

                console.log('end of init');
            }

            // try splitting out init() vs main() functions to ensure data is fully loaded
            function main(){
                console.log('main called');
                map = new L.Map('map', {
                    center: [42.3301, -71.0589],
                    zoom: 12
                })

                L.tileLayer('https://dnv9my2eseobd.cloudfront.net/v3/cartodb.map-4xtxp73f/{z}/{x}/{y}.png', {
                    attribution: 'Mapbox <a href="http://mapbox.com/about/maps" target="_blank">Terms &amp; Feedback</a>'
                }).addTo(map);

                cartodb.createLayer(map, viz_url)
                .addTo(map)
                .on('done', function(layer){
                    var subLayerOptions = {
                        sql: sql_summ,
                        cartoss: summCSS,
                    };

                    console.log('num sublayers:', layer.getSubLayerCount());

                    var sublayer = layer.getSubLayer(0);
                    sublayer.set(subLayerOptions);
                    //sublayer.remove();

                    //console.log('before attempt to create layer');
                    //console.log('sql_summ is:', sql_summ);
                    //console.log('and summCSS is:', summCSS);

                    //var summLayer = layer.createSubLayer(subLayerOptions);

                    cdb.vis.Vis.addInfowindow(map, sublayer, ["amb_temp", "amb_lux"]);
                    sublayers.push(sublayer);

                    // console.log('layer.subLayer(0) css is ', layer.getSubLayer(0).get('cartocss'));

                    var rawLayer = layer.createSubLayer({
                        sql: sql_raw,
                        cartocss: rawCSS,
                    });//.hide();
                    cdb.vis.Vis.addInfowindow(map, rawLayer, ["amb_temp", "amb_lux"]);
                    sublayers.push(rawLayer);
                    sublayers[1].hide();

                    // does it work to wrap listener inside other listener like this?
                    sublayers[0].on('featureClick', function(e, latlng, pos, data, subLayerIndex){
                        console.log('summary layer clicked, e is', e, '\nlatlng is', latlng, '\npos is', pos, '\ndata is', data, '\subLayerIndex is', subLayerIndex);
                    });

                    sublayers[1].on('featureClick', function(e, latlng, pos, data, subLayerIndex){
                        console.log('raw layer clicked, e is', e, '\nlatlng is', latlng, '\npos is', pos, '\ndata is', data, '\subLayerIndex is', subLayerIndex);
                    });


                });

                // dygraph for visualizations, note need to update to just temperature or temp on left axis humidity on right?
                var tempLine = new Dygraph(document.getElementById('temperature-chart'), dataQuarters.data, {
                                            labels: dataQuarters.headers,
                                            title: "Temperature and humidity",
                                            ylabel: "Avg Values",
                                            xlabel: "time of day (HHMM, minutes stretched to base 100)"
                });

                // test larger dataset read from local csv
                var roadLine = new Dygraph(document.getElementById('accelerometer-chart'), dataRoads.data, {
                    labels: dataRoads.headers,
                    title: "road quality - testing data size",
                    ylabel: "rdq means",
                    xlabel: "time"
                });

                // layer toggle button, for now only changes map
                $('.button').click(function() {
                    $('.button').removeClass('selected');
                    $(this).addClass('selected');
                    //this gets the id of the different buttons and calls to LayerActions which responds according to the selected id
                    LayerActions[$(this).attr('id')]();
                }).on('error', function(err) {
                    //log the error
                    console.log('error is ', err);
                });
            }

            // create CartoCSS string, assumes "summary_tbl" is a polygon and "raw_tbl" is points
            /* @params:
                    tbl_name = table to be styled
                    bins = array of bin values, expected to be max of bin as per CartoDB functions (eg CDB_JenksBins used above)
                    col = column to visualize, should be same column used to crete <bins> variable
            */
            function makeCartoCSS(tbl_name, bins, col){
                // update to dynamically call color pallete (eventually of user choice) of same length as "bins"
                colorPallete = ['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#E7298A', '#CE1256', '#91003F']

                if (tbl_name == summary_tbl) {
                    var tmp_css = '#' + tbl_name + '{ polygon-fill: #F1EEF6; polygon-opacity: 0.8; line-color: #FFF; line-width: 0.5; line-opacity: 1;}';
                    for (var i = bins.length-1; i >= 0; i--) {
                        // console.log('bin[', i, '] is ', bins[i])
                        tmp_css = tmp_css + '#' + tbl_name + ' [ '+ col + ' <= ' + bins[i] + '] { polygon-fill: ' + colorPallete[i] + '; }';
                    }
                } else if (tbl_name == raw_tbl){
                    var tmp_css = '#' + tbl_name + '{   marker-fill-opacity: 0.8; marker-line-color: #FFF; marker-line-width: 0.5; marker-line-opacity: 0.5; marker-width: 10; marker-fill: #FFFFB2; marker-allow-overlap: true;}';
                    for (var i = bins.length-1; i >= 0; i--) {
                        // console.log('bin[', i, '] is ', bins[i])
                        tmp_css = tmp_css + '#' + tbl_name + ' [ ' + col + ' <= ' + bins[i] + '] { marker-fill: ' + colorPallete[i] + '; }';
                    }
                } else { // should never get here as hard coding raw and summary options fed programmatically above, catches when code not fully updated
                    var tmp_css = '#null{ marker-fill-opacity: 0.9; marker-line-color: #FFF; marker-line-width: 1; ',
                        tmp_css = tmp_css + 'marker-line-opacity: 1; marker-placement: point; marker-type: ellipse; ',
                        tmp_css = tmp_css + 'marker-width: 10; marker-fill: #FF6600; marker-allow-overlap: true;}';
                }
                return tmp_css;
            }
        </script>
    </head>

    <body onload="init()">
        <div id='map'></div>
        <div id='menu'>
            <a href="#summary" id="summary" class="button summary">summary</a>
            <a href="#raw" id="raw" class="button raw">raw</a>
        </div>
        <div id='dashboard'>
            <div id='temperature-chart'></div>
            <div id='humidity-chart'></div>
            <div id='accelerometer-chart'></div>
        </div>
    </body>
</html>
